@inherits LayoutComponentBase
@inject NavigationManager NavMan
@inject Data.AASService SubmodelService
@using AasxServer
@inject IRegistryInitializerService AasRegistryService
@using IO.Swagger.Registry.Lib.V3.Interfaces;

<style>
    @@keyframes rotation {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    } 
    
    header {
        position: fixed;
        top: 0;
        width: 100%;
    }
    
    .main {
        height: 100vh;
    }

    .navbar {
        display: flex;
        justify-content: center;
        padding: 10px 0;
    }

    .logo {
        max-height: 3.63rem;
        margin-left: 0.3125rem;
        margin-right: 0.3125rem;
    }

    .logo-container {
        display: flex;
        align-items: center;
    }

    .nav-link {
        margin-right: 20px;
    }

    .content {
        padding: 20px 0;
        margin-top: 5rem;
        text-align: center;
    }
    
    .loading {
        color: white;
        background-color: blue;
    }
</style>

<div class="main">
    @if (Program.isLoading)
    {
        <span class="loading">Loading...</span>
        System.Threading.Thread.Sleep(1000);
        StateHasChanged();
    }
    else
    {
        InitializeCredentialsAndRegistry();

        var isProductCarbonFootprintShowcase = IsProductCarbonFootprintShowcaseUri(NavMan.Uri);

        if (!isProductCarbonFootprintShowcase)
        {
            <header>
                <div class="navbar">
                    <span class="title">
                        <strong>AASX Browser</strong>
                    </span>
                    <div class="logo-container">
                        <img src="2022-02-15_IDTA_AAS-Logo_Final_RGB.png" alt="AASX Logo" class="logo">
                        <img src="Logo_IDTA.jpg" alt="IDTA Logo" class="logo">
                        <img src="SpecPI40_t.png" alt="SpecPI40 Logo" class="logo">
                    </div>
                    <nav>
                        <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                            <span class="oi oi-list-rich" aria-hidden="true"></span> AASX Model
                        </NavLink>
                        <NavLink class="nav-link" href="About" Match="NavLinkMatch.All">
                            <span class="oi oi-list-rich" aria-hidden="true"></span> LICENSE.TXT
                        </NavLink>
                    </nav>
                </div>
            </header>

            <div class="content">
                @Body
            </div>
        }
        else
        {
            <CarbonFootprintShowcaseLayout></CarbonFootprintShowcaseLayout>
        }
    }
</div>

@code {
    static string _input = "";

    protected override void OnInitialized()
    {
        SubmodelService.NewDataAvailable += NewData;
    }

    public void Dispose()
    {
        SubmodelService.NewDataAvailable -= NewData;
    }

    void NewData(object source, EventArgs args)
    {
        if (Program.isLoading)
            return;

        if (args is not Program.NewDataAvailableArgs newArgs)
        {
            return;
        }

        var newDataMode = newArgs.signalNewDataMode;
        if (newDataMode != 0)
        {
            InvokeAsync(StateHasChanged);
        }
    }

    void InitializeCredentialsAndRegistry()
    {
        if (_input != "")
        {
            return;
        }

        _input = "anonymous";
        AasxCredentials.initAnonymous(cs.credentials);
        AasRegistryService.InitRegistry(cs.credentials, DateTime.UtcNow);
        AasxTask.resetTimeStamp();
    }

    static bool IsProductCarbonFootprintShowcaseUri(string uri)
    {
        string[] pcfEndings = {"/pcf", "/pcf/", "/pcf2", "/pcf2/", "/pcf2edc", "/pcf2edc/"};
        return pcfEndings.Any(uri.EndsWith);
    }

}